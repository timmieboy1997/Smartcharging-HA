blueprint:
  name: Slimme batterij laadplanning - Frank Energie
  description: Laadt automatisch de batterij op de goedkoopste momenten op basis van Frank Energie prijzen.
  domain: automation
  input:
    battery_reserve_switch:
      name: Reserve mode switch
      selector:
        entity:
          domain: switch
    battery_soc_sensor:
      name: Batterij SOC sensor
      selector:
        entity:
          domain: sensor
    frank_price_sensor:
      name: Frank Energie prijs sensor
      selector:
        entity:
          domain: sensor
    solar_forecast_sensor:
      name: Verwachte zonopbrengst (kWh)
      default: ""
      selector:
        entity:
          domain: sensor
    min_solar_day:
      name: Minimale zon kWh voor dagladen
      default: 8
      selector:
        number:
          min: 0
          max: 20
          step: 0.1
          unit_of_measurement: "kWh"
    load_start_hour:
      name: Start uur controleren
      default: 0
      selector:
        number:
          min: 0
          max: 23
    load_end_hour:
      name: Eind uur controleren
      default: 23
      selector:
        number:
          min: 0
          max: 23

variables:
  battery_reserve_switch: !input battery_reserve_switch
  battery_soc_sensor: !input battery_soc_sensor
  frank_price_sensor: !input frank_price_sensor
  solar_forecast_sensor: !input solar_forecast_sensor
  min_solar_day: !input min_solar_day
  load_start_hour: !input load_start_hour
  load_end_hour: !input load_end_hour

trigger:
  - platform: time_pattern
    minutes: "1"
  - platform: time_pattern
    minutes: "31"

action:
  - variables:
      # JSON parsing van Frank Energie prijzen
      raw: "{{ state_attr(frank_price_sensor, 'prices') }}"
      prices_json: >-
        {% if raw %}
          {% set text = raw | string %}
          {% set matches = text | regex_findall(
            "datetime\\.datetime\\(\\d+, \\d+, \\d+, (\\d+), (\\d+).*?\\).*?"
            "datetime\\.datetime\\(\\d+, \\d+, \\d+, (\\d+), (\\d+).*?\\).*?"
            "price': ([0-9.]+)"
          ) %}
          [
          {%- for m in matches %}
            {
              "from_hour": {{ m[0]|int }},
              "from_minute": {{ m[1]|int }},
              "till_hour": {{ m[2]|int }},
              "till_minute": {{ m[3]|int }},
              "price": {{ m[4]|float }}
            }{{ "," if not loop.last }}
          {%- endfor %}
          ]
        {% else %} [] {% endif %}

      # Berekeningen gemiddelde prijs
      all_prices: "{{ prices_json | map(attribute='price') | list }}"
      avg_day: >-
        {% if all_prices|length > 0 %}
          {{ (all_prices | sum / all_prices|length) | round(4) }}
        {% else %}
          none
        {% endif %}
      avg_night: >-
        {% set night_prices = prices_json | selectattr('from_hour','lt',7) | map(attribute='price') | list %}
        {% if night_prices | length > 0 %}
          {{ (night_prices | sum / night_prices|length) | round(4) }}
        {% else %}
          none
        {% endif %}
      avg_dayblock: >-
        {% set dayblock_prices = prices_json | selectattr('from_hour','ge',11) | selectattr('from_hour','lt',15) | map(attribute='price') | list %}
        {% if dayblock_prices | length > 0 %}
          {{ (dayblock_prices | sum / dayblock_prices|length) | round(4) }}
        {% else %}
          none
        {% endif %}
      current_hour: "{{ now().hour }}"
      current_price: "{{ states(frank_price_sensor) | float }}"

  - choose:
      - conditions:
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            below: 100
          - condition: template
            value_template: >-
              {% if current_hour >= load_start_hour and current_hour <= load_end_hour %}
                {% if current_hour >=0 and current_hour < 7 %}
                  {{ avg_night is not none and current_price < avg_night }}
                {% elif current_hour >=11 and current_hour < 15 %}
                  {{ avg_dayblock is not none and current_price < avg_dayblock }}
                {% else %}
                  {{ avg_day is not none and current_price < avg_day }}
                {% endif %}
              {% else %}
                false
              {% endif %}
          - condition: numeric_state
            entity_id: !input solar_forecast_sensor
            below: !input min_solar_day
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input battery_reserve_switch

      - conditions:
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: !input battery_soc_sensor
                above: 99
              - condition: template
                value_template: >-
                  {% if current_hour >=0 and current_hour < 7 %}
                    {{ avg_night is not none and current_price >= avg_night }}
                  {% elif current_hour >=11 and current_hour < 15 %}
                    {{ avg_dayblock is not none and current_price >= avg_dayblock }}
                  {% else %}
                    {{ avg_day is not none and current_price >= avg_day }}
                  {% endif %}
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input battery_reserve_switch
